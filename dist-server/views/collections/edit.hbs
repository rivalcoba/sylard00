<div class="container-fluid" id="contenedor_agregar_coleccion">
  <div class="container-fluid" id="cabezal_editar_coleccion">
    <div class="container">
      <div class="col-sm-12" id="contenedor_items_cabezal_agregar_coleccion">
        <div class="" id="contenedor_titulos_cabezal_agregar_coleccion">
          <h1 id="titulo_agregar_coleccion">
            <span class="icono_cabezal icon-edit"></span>
            Editar Colección
          </h1>
          <h2 class="llamada" id="llamada_agregar_coleccion">
            Modifica los campos correctamente
          </h2>
        </div>
      </div>
    </div>
  </div>
  <section class="container">
    <div
      class="col-sm-12 contenedor-90vh"
      id="contenedor_general_agregar_coleccion"
    >
      <form id="app" action="/collections/edit/{{collectionDoc._id}}?_method=PUT" method="POST">
      	<input type="hidden" name="_method" value="PUT">
        	<!-- Collection Name -->
        <div class="contenedor_input_agregar_coleccion">
          <label
            class="label"
            id="nombre_de_la_coleccion"
            for="nombre_coleccion"
          >
            Nombre de la colección
          </label>
          <input
          	id="name" 
            name="name"
            v-model="name"
            class="input_ancho_completo"
            type="text"
            placeholder="Titulo breve (max 120 carácteres)"
            maxlength="120"
            required
          />
          <div class="contenedor_icono_correcto_input">
            <p>
              <span class="icono_correcto_input icon-check_circle"></span>
            </p>
          </div>
          <div class="contenedor_icono_error_input">
            <p>
              <span class="icono_error_input icon-error"></span>
            </p>
          </div>
        </div>
        <div class="contenedor_input_agregar_coleccion">
          <label
            class="label"
            id="descripcion_de_la_coleccion"
            for="descripcion_coleccion_input"
          >
            Descripcion de la coleccion
          </label>
          <textarea
            name="description"
            id="description"
            class="input_ancho_completo"
            type="textarea"
            placeholder="Breve descripcion (max 200 carácteres)"
            maxlength="200"
            rows="5"
            v-model="description"
            required
          ></textarea>
        </div>
        	<!-- Collections Languages -->
        <p class="label" id="lenguas_de_la_coleccion">
          Lenguas de la colección
        </p>
        <div class="contenedor_etiqueta_agregar_coleccion_lenguas">
          <div class="contenedor_inputs_agregar_coleccion_lengua">
            <div class="modulo_inputs_lengua" id="">
              <label class="label label_al_100">
                Lengua terminal:
              </label>
              <input 
              type="text" 
              id="language" 
              onchange="editCollectionScripts.fillLangGroupList(app)"
              class="input_flexible" 
               list="langlist">
              <datalist id="langlist">
				<option 
					v-for="language in languages"
					:id="language._id"
					:value="language.name + ' | ' + language.gid"
					>
      </datalist>
              <div class="contenedor_icono_correcto_input">
                <p>
                  <span class="icono_correcto_input icon-check_circle"></span>
                </p>
              </div>
              <div class="contenedor_icono_error_input">
                <p>
                  <span class="icono_error_input icon-error"></span>
                </p>
              </div>
            </div>
             <!-- Language Group -->
            <div class="modulo_inputs_lengua">
              <label class="label label_al_100">
                Grupo de lenguas:
              </label>
              <input 
              :disabled = "!languagesGroup.length > 0"
               id="langGroup" 
               name="langGroup"
                list="groupLanglist"
              type="text" 
              class="input_flexible" 
             >
              <div class="contenedor_icono_correcto_input">
                <p>
                  <span class="icono_correcto_input icon-check_circle"></span>
                </p>
              </div>
              <div class="contenedor_icono_error_input">
                <p>
                  <span class="icono_error_input icon-error"></span>
                </p>
              </div>
            </div>
            <div class="modulo_boton_lengua">
              <button class="btn_lateral_input_agregar_lengua">
                <span class="icono_boton_lateral icon-plus"></span>
              </button>
            </div>
          </div>
          <div class="contenedor_lenguas_agregadas">
            <p class="label">
              Lenguas agregadas a la colección
              {{!--table collection--}}
            </p>
            <table  id="langTable" class="tabla_lenguas_agregadas">
              <thead></thead>
              <tr v-for="(langs, index) in colLanguages" class="row_lenguas_agregadas">
                <td class="lengua_terminal_glottocode_agregar_coleccion">
                  \{{ langs.language.gid }}
                </td>
                <td class="">
                 \{{ langs.language.name }}
                </td>
                <td class="grupo_terminal_glottocode_agregar_coleccion">
                  \{{ langs.LanguageGroup.gid }}
                </td>
                <td class="">
                  \{{ langs.LanguageGroup.name }}
                </td>
                <td class="">
                  <div class="contenedor_botones_accion_lengua">
                    <button  @click="removeLangs(index)" class="btn_accion_tabla float_right">
                      <span class="icono_accion_tabla  icon-delete"></span>
                    </button>
                  </div>
                </td>
              </tr>
            </table>
          </div>
        </div>
        <p class="label" id="comunidades_de_la_coleccion">
          Comunidades de la colección
        </p>
        <div class="contenedor_etiqueta_agregar_coleccion_comunidad">
          <div class="contenedor_inputs_agregar_coleccion_comunidad2">
            <div class="contenedor_inputs_boton_lateral">
              <div class="modulo_inputs_comunidad2" id="">
                <label class="label label_al_100">
                  País:
                </label>
                <input type="text" placeholder="México" class="input_flexible"  readonly/>
                <div class="contenedor_icono_correcto_input">
                  <p>
                    <span class="icono_correcto_input icon-check_circle"></span>
                  </p>
                </div>
                <div class="contenedor_icono_error_input">
                  <p>
                    <span class="icono_error_input icon-error"></span>
                  </p>
                </div>
              </div>
              <div class="modulo_inputs_comunidad2" id="">
                <label class="label label_al_100">
                  Entidad:
                </label>
                <input type="text" class="input_flexible" required />
                <div class="contenedor_icono_correcto_input">
                  <p>
                    <span class="icono_correcto_input icon-check_circle"></span>
                  </p>
                </div>
                <div class="contenedor_icono_error_input">
                  <p>
                    <span class="icono_error_input icon-error"></span>
                  </p>
                </div>
              </div>
              <div class="modulo_inputs_comunidad2">
                <label class="label label_al_100">
                  Municipio:
                </label>
                <input type="text" class="input_flexible" required />
                <div class="contenedor_icono_correcto_input">
                  <p>
                    <span class="icono_correcto_input icon-check_circle"></span>
                  </p>
                </div>
                <div class="contenedor_icono_error_input">
                  <p>
                    <span class="icono_error_input icon-error"></span>
                  </p>
                </div>
              </div>
              <div class="modulo_inputs_comunidad2">
                <label class="label label_al_100">
                  Localidad:
                </label>
                <input type="text" class="input_flexible" required />
                <div class="contenedor_icono_correcto_input">
                  <p>
                    <span class="icono_correcto_input icon-check_circle"></span>
                  </p>
                </div>
                <div class="contenedor_icono_error_input">
                  <p>
                    <span class="icono_error_input icon-error"></span>
                  </p>
                </div>
              </div>
              <div class="modulo_inputs_comunidad2" id="">
                <label class="label label_al_100">
                  Latitud:
                </label>
                <input type="text" class="input_flexible" required />
                <div class="contenedor_icono_correcto_input">
                  <p>
                    <span class="icono_correcto_input icon-check_circle"></span>
                  </p>
                </div>
                <div class="contenedor_icono_error_input">
                  <p>
                    <span class="icono_error_input icon-error"></span>
                  </p>
                </div>
              </div>
              <div class="modulo_inputs_comunidad2" id="">
                <label class="label label_al_100">
                  Longitud:
                </label>
                <input type="text" class="input_flexible" required />
                <div class="contenedor_icono_correcto_input">
                  <p>
                    <span class="icono_correcto_input icon-check_circle"></span>
                  </p>
                </div>
                <div class="contenedor_icono_error_input">
                  <p>
                    <span class="icono_error_input icon-error"></span>
                  </p>
                </div>
              </div>
            </div>
            <div class="modulo_boton_comunidad">
              <button class="btn_lateral_input_agregar_comunidad">
                <span class="icono_boton_lateral icon-plus"></span>
              </button>
            </div>
          </div>
          <div class="contenedor_comunidades_agregadas">
            <p class="label">
              Comunidades agregadas a la colección
            </p>
            {{!--table localities--}}
            <table id="locTable" class="tabla_comunidades_agregadas">
              <thead></thead>
              <tr  v-for="(loc, index) in localities" class="row_comunidades_agregadas">
                <td class="comunidad_agregar_coleccion">
                  \{{loc.Nom_Loc}}
                </td>
                <td class="municipio_agregar_coleccion">
                 \{{loc.Nom_Mun}}
                </td>
                <td class="entidad_agregar_coleccion">
                 \{{loc.Nom_Ent}}
                </td>
                <td class="pais_agregar_coleccion">
                  México
                </td>
                <td class="latitud_agregar_coleccion">
                  \{{loc.Lat_Decimal}}
                </td>
                <td class="longitud_agregar_coleccion">
                  \{{loc.Lon_Decimal}}
                </td>
                <td class="">
                  <div class="contenedor_botones_accion_lengua">
                    <button @click="removeLocs(index)" class="btn_accion_tabla float_right">
                      <span class="icono_accion_tabla  icon-delete"></span>
                    </button>
                  </div>
                </td>
              </tr>
            </table>
          </div>
        </div>
        <div class="contenedor_licencia_y_botones_agregar_coleccion">
          <div class="contenedor_licencia">
            <label class="label" for="licencia">
              Licencia del contenido
            </label>
            <select name="license" id="license" v-model="license">
              <option value="" disabled selected>{{translation.SELECT_AN_OPTION}}
              <option value="CC-BY-NC-SA">CC-BY-NC-SA
				      <option value="CC BY-SA">CC BY-SA
            </select>
            <div class="contenedor_icono_correcto_input">
              <p>
                <span class="icono_correcto_input icon-check_circle"></span>
              </p>
            </div>
            <div class="contenedor_icono_error_input">
              <p>
                <span class="icono_error_input icon-error"></span>
              </p>
            </div>
          </div>
          <div class="contenedor_botones">
            <button
              type="reset"
              class="btn btn-secundario"
              id="boton_restablecer_agregar_coleccion"
            >
              Restablecer
            </button>
            <button
              type="submit"
              class="btn btn-primario"
              id="boton_guardar_agregar_coleccion"
            >
              Guardar
            </button>
          </div>
        </div>
      </form>
    </div>
  </section>
</div>

<!-- VUE  -->
  <script src="https://unpkg.com/vue" crossorigin="anonymous"></script>
<script>

  const getLangObj = function(stringVal){
    return {
      gid: stringVal.split(' | ')[1],
      name: stringVal.split(' | ')[0]
    }
  }

	var app = new Vue({
		el: '#app',
		data: {
      name: '{{collectionDoc.name}}',
      description: '{{collectionDoc.description}}',
			languages : [],
      languagesGroup : [],
      colLanguages: {{{collectionDoc.languages}}},
      localities : {{{collectionDoc.localities}}},
      entitiesList : [],
      municipalitiesList: [],
      localitiesList: [],
      license: '{{collectionDoc.license}}'
		},
    methods:{
      removeLangs : function(idx){
        this.colLanguages.splice(idx, 1)
      },
      removeLocs : function(idx){
        this.localities.splice(idx, 1)
      },
      addLanguages : function(){
        let lang = getLangObj(document.getElementById('language').value) 
        let langGroup = getLangObj(document.getElementById('langGroup').value)

        // Check if langGeoup is valid
        let validLangGroup = this.languagesGroup.map(function(langOption){
          return langOption.name == langGroup.name && langOption.gid == langGroup.gid
        }).reduce(function(acc, current){
          return acc || current
        })

        if(!validLangGroup){
          return alert("Grupo de lengia Invalido")
          document.getElementById('langGroup').value = ""
        }

        // Check if language have been choosed previously
        let areadySelected = false
        for(let index = 0; index < this.colLanguages.length; index++){
          areadySelected = this.colLanguages[index].language.name == lang.name
          if (areadySelected){
            break
          }
        }
        if(areadySelected){
          alert("Ya se ha seleccionado esta lengua")
        }else{
          this.colLanguages.push({
            language : lang,
            LanguageGroup : langGroup
          })
        }
        document.getElementById('language').value = ""
        document.getElementById('langGroup').value = ""
      },
      addLocality : function(){
        let ent = document.getElementById('entity').value
        let mun = document.getElementById('municipality').value
        let loc = document.getElementById('locality').value

        let locationsOk = this.localitiesList.map(function(locality){
          return locality == loc
        })
        .reduce((res, current)=>{
          return res || current
        })
        
        if(!locationsOk){
          alert('Seleccionar una localidad de la lista')
          return document.getElementById('locality').value  = ""
        }

        editCollectionScripts.getLocality(ent, mun, loc).then((locality)=>{
          // Check if location was already chosen
          let areadySelected = this.localities.map(function(loc){
            return loc.Nom_Ent == locality.Nom_Ent && loc.Nom_Mun == locality.Nom_Mun && loc.Nom_Loc == locality.Nom_Loc
          }).reduce((res, current)=>{
            return res || current
          })

          if(areadySelected){
            alert("Ya se ha seleccionado esa lengua")
          }else{
            this.localities.push(locality)
          }
          document.getElementById('entity').value = ""
          document.getElementById('municipality').value = ""
          document.getElementById('locality').value = ""
        })
      }
    }
	})	
</script>